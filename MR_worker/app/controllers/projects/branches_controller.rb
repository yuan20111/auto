class Projects::BranchesController < Projects::ApplicationController
  include ActionView::Helpers::SanitizeHelper
  include Gitlab::ConfigHelper
  # Authorize
  before_filter :require_non_empty_project

  before_filter :authorize_download_code!
  before_filter :authorize_push_code!, only: [:create, :destroy]

  def index
    @sort = params[:sort] || 'name'
    @branches = @repository.branches_sorted_by(@sort)
    @branches = Kaminari.paginate_array(@branches).page(params[:page]).per(30)
  end

  def recent
    @branches = @repository.recent_branches
  end

  def create
    branch_name = sanitize(strip_tags(params[:branch_name]))
    ref = sanitize(strip_tags(params[:ref]))
    result = CreateBranchService.new(project, current_user).
        execute(branch_name, ref)

    if result[:status] == :success
      @branch = result[:branch]
      redirect_to project_tree_path(@project, @branch.name)
    else
      @error = result[:message]
      render action: 'new'
    end
  end

  def destroy
    DeleteBranchService.new(project, current_user).execute(params[:id])
    @branch_name = params[:id]

    respond_to do |format|
      format.html { redirect_to project_branches_path(@project) }
      format.js
    end
  end

  # precompile source branch, include commits content
  def precompile
      
    commits_id = params[:id]
    commits_arr = commits_id.split("\/")
  
    # get source branch name by commit id
    source_branch_name = @project.repository.branch_names_contains(commits_arr[0]);
    source_branch_name = source_branch_name.join("");

    # commits id converts to string
    commits_str = commits_arr.join(" ")

    #pro_path: namespace/project
    pro_path = @project.path_with_namespace
    # current_user
    strobj = User.find(current_user.id)

    ## Make note File, File path defined by customer
    if ("#{@project.namespace.type}" == "Group")
      file_path = "./precompile/#{@project.name}-#{source_branch_name}.txt"
      fl = File.open( "#{file_path}", "w+")
      fl.write("分 支  : git@#{gitlab_config.host}:#{pro_path}.git #{source_branch_name}\n")
      fl.write("邮 箱  : #{strobj.notification_email}\n")
      fl.write("Commits: #{commits_str}\n")
      fl.close
      @project.scp_branch_info(file_path)
    end

    respond_to do |format|
      format.html
      format.js { render 'precompile_source_branch.js.erb', locals: { project: @project } }
    end
 end

end
